<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_preparation.xml" version="5.0" xml:id="cha-update-preparation">
 <title>Préparation de la mise à niveau</title>
 <info>
  <abstract>
   <para>
    Avant de lancer la procédure de mise à niveau, assurez-vous que votre système est prêt. Cette préparation implique, entre autres, la sauvegarde des données et la consultation des notes de version. Le chapitre suivant vous guide tout au long de ces étapes.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <remark>jufa 2021-02-09: suggestion to give this chapter a facelift:
 Chapter 3: Preparing the upgrade - Intro - Procedure w check system version,
 release notes, back-up, listing packages, create proposal</remark>
 

 <sect1 xml:id="sec-update-preparation-update">
  <title>Vérification de l'actualisation du système</title>

  <para os="sles;sled">
   <remark>jufa 2021-02-09: add what to do if the system is older? check what
    is meant with patch level. check if update path is supported,
    link to sec-upgrade-path-supported</remark>
   La mise à niveau du système est prise en charge uniquement à partir du niveau de correctif le plus récent. Assurez-vous que les dernières mises à jour système sont installées <phrase os="sles;sled">soit</phrase>, en exécutant <command>zypper
   patch</command><phrase os="sles;sled"> ou en démarrant le module YaST <guimenu>Online-Update</guimenu></phrase>.
  </para>

  


    <note os="sles;sled" xml:id="new-4096-bit-rpm-key">
      <title>nouvelle clé de signature de 4 096 bits pour SUSE Linux Enterprise 15</title>
      <para>
        Au milieu de l'année 2023, la gamme de produits SUSE Linux Enterprise 15 est passée d'une clé de signature RSA de 2 048 bits à une nouvelle clé RSA de 4 096 bits. Cette modification concerne les paquets RPM, les dépôts de paquets et les signatures ISO. Les anciens dépôts qui ne sont plus mis à jour et les RPM publiés jusqu'à la date de basculement restent signés avec l'ancienne clé de 2 048 bits.
      </para>
      <para>
        Si vous mettez à jour votre système, la nouvelle clé est automatiquement importée dans le trousseau de clés RPM à partir du paquet <package>suse-build-key</package> sous SLE 15 SP4 et SP5, ainsi que dans les versions LTSS de SLE 15 SP1, SP2 et SP3.
      </para>
      <para>
        Si la clé n'a pas encore été importée, vous pouvez l'importer manuellement avec la commande suivante :
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rpm --import /usr/lib/rpm/gnupg/keys/gpg-pubkey-3fa1d6ce-63c9481c.asc</command></screen>
      <para>
        Si vous exécutez une version plus ancienne de SLE ou si vous n'avez pas importé la nouvelle clé, vous serez invité à l'approuver pendant la mise à niveau. Vérifiez que l'empreinte correspond :
      </para>
<screen>pub   rsa4096/0xF74F09BC3FA1D6CE 2023-01-19 [SC] [expires: 2027-01-18]
Key fingerprint = 7F00 9157 B127 B994 D5CF  BE76 F74F 09BC 3FA1 D6CE
uid           SUSE Package Signing Key &lt;build@suse.de&gt;</screen>
      <para>
        En outre, une clé RSA de réserve de 4 096 bits a été importée à des fins de reprise après sinistre :
      </para>
<screen>pub   rsa4096/0xA1BFC02BD588DC46 2023-01-19 [SC] [expires: 2033-01-16]
Key fingerprint = B56E 5601 41D8 F654 2DFF  3BF9 A1BF C02B D588 DC46
uid           SUSE Package Signing Key (reserve key) &lt;build@suse.de&gt;</screen>
      <para>
        Cette clé peut être importée manuellement à l'aide de la commande suivante :
      </para>
      <screen><prompt>&gt; </prompt><command>sudo</command> <command>rpm --import /usr/lib/rpm/gnupg/keys/gpg-pubkey-d588dc46-63c939db.asc</command></screen>
      <para>
        Les deux clés sont également disponibles sur le support d'installation et sur le site Web de SUSE à l'adresse suivante : <link xlink:href="https://www.suse.com/support/security/keys/"></link>.
      </para>
    </note>

 </sect1>
 <sect1 xml:id="sec-update-preparation-relnotes">
  <title>Lecture des notes de version</title>

  <para>
   Vous trouverez une liste de toutes les modifications, les nouvelles fonctionnalités et les problèmes connus dans les <link xlink:href="https://www.suse.com/releasenotes/">notes de version</link>. Vous pouvez également trouver les notes de version sur le support d'installation dans le répertoire <filename>docu</filename>.
  </para>

  <para>
   Les notes de version contiennent généralement uniquement les changements effectués entre deux versions successives. <phrase os="sles;sled">Si vous omettez d'installer un ou plusieurs Service Packs, consultez néanmoins les notes de version de ces Service Packs ignorés.</phrase>
  </para>

  <para>
   Consultez les notes de version pour vérifier si les conditions suivantes s'appliquent :
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Votre matériel implique certaines considérations spéciales.
    </para>
   </listitem>
   <listitem>
    <para>
     Des paquets logiciels utilisés actuellement ont été considérablement modifiés.
    </para>
   </listitem>
   <listitem>
    <para>
     Votre installation nécessite des précautions particulières.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-update-preparation-backup">
  <title>Exécution d'une sauvegarde</title>

  <para>
   Avant la mise à niveau, sauvegardez vos données en copiant les fichiers de configuration existants sur un support distinct (tel qu'un périphérique à bande, un disque dur amovible, etc). Cela concerne principalement les fichiers stockés dans le répertoire <filename>/etc</filename>, ainsi que certains répertoires et fichiers sous <filename>/var</filename> et <filename>/opt</filename>. Vous pouvez également écrire les données de l'utilisateur de <filename>/home</filename> (les répertoires <envar>HOME</envar>) sur un support de sauvegarde.
  </para>

  <para>
   Sauvegardez ces données en tant qu'utilisateur <systemitem class="username">root</systemitem>. Seul l'utilisateur <systemitem class="username">root</systemitem> a des droits suffisants pour tous les fichiers locaux.
  </para>

  <para os="sles;sled">
   <remark>jufa 2021-02-09: check if backup function still exists and how it
    works. rework para accordingly: alternative for data back up</remark>
   Si vous avez sélectionné <guimenu>Mettre à jour un système existant</guimenu> comme mode d'installation dans YaST, vous pouvez choisir d'effectuer une sauvegarde (système) ultérieurement. Vous pouvez inclure tous les fichiers modifiés, ainsi que ceux issus du répertoire <filename>/etc/sysconfig</filename>. Il ne s'agit toutefois pas d'une sauvegarde complète, dans la mesure où il manque tous les autres répertoires importants mentionnés ci-dessus. Recherchez la sauvegarde dans le répertoire <filename>/var/adm/backup</filename>.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-disk">
  <title>Vérification de l'espace disque disponible</title>

  <para>
   La taille des logiciels tend à augmenter de versions en versions. Il convient donc de vérifier l'espace disponible sur la partition avant d'effectuer la mise à jour. Si vous pensez que vous allez manquer d'espace disque, sauvegardez vos données avant d'augmenter l'espace disponible en redimensionnant des partitions, par exemple. Il n'existe pas de règle précise concernant l'espace de chaque partition. L'espace requis dépend de votre profil particulier de partitionnement et du logiciel sélectionné.
  </para>

  <note os="sles;sled">
   <title>vérification automatique de l'espace dans YaST</title>
   <para>
    Au cours de la procédure de mise à jour, YaST vérifie la quantité d'espace disque disponible et affiche un avertissement si la taille de l'installation risque de dépasser la quantité d'espace disponible. Dans ce cas, la mise à jour risque de rendre le <emphasis>système inutilisable</emphasis> ! Si vous savez exactement ce que vous faites (en ayant effectué des tests au préalable), vous pouvez ignorer l'avertissement et poursuivre la mise à jour.
   </para>
  </note>

  <sect2 os="sles;sled" xml:id="sec-update-preparation-disk-space">
   <title>Vérification de l'espace disque sur des systèmes de fichiers non-Btrfs</title>
   <para>
    Utilisez la commande <command>df</command> pour obtenir une liste de l'espace disque disponible. Dans l'<xref linkend="ex-update-df"/>, la partition root est <filename>/dev/sda3</filename> (montée en tant que <filename>/</filename>).
   </para>
   <example xml:id="ex-update-df">
    <title>Listage avec <command>df -h</command></title>
    
    <screen os="sles">Filesystem     Size  Used Avail Use% Mounted on
     /dev/sda3       74G   22G   53G  29% /
     tmpfs          506M     0  506M   0% /dev/shm
     /dev/sda5      116G  5.8G  111G   5% /home
     /dev/sda1       44G    4G   40G   9% /data</screen>
   </example>
  </sect2>

  <sect2 xml:id="sec-update-preparation-disk-btrfs-on-root">
   <title>Vérification de l'espace disque sur des systèmes de fichiers racines Btrfs</title>
   
   <para>
    Sur un système de fichiers Btrfs, la sortie de <command>df</command> peut être trompeuse, étant donné que, en plus de l'espace alloué par les données brutes, un système de fichiers Btrfs alloue et utilise également de l'espace pour les métadonnées.
   </para>
   <para>
    Par conséquent, un système de fichiers Btrfs peut signaler un manque d'espace, même s'il semble qu'il reste une grande quantité d'espace disponible. Dans ce cas, tout l'espace alloué aux métadonnées est utilisé. <phrase os="sles">Pour plus de détails sur la vérification de l'espace utilisé et disponible sur un système de fichiers Btrfs, reportez-vous au <xref linkend="sec-filesystems-major-btrfs-suse-space"/>&#x002E;</phrase> Pou plus d'informations, reportez-vous à la commande <phrase os="sles;sled"><command>man 8
     btrfs-filesystem</command> et à la </phrase><link xlink:href="https://btrfs.wiki.kernel.org/index.php/FAQ"></link>.
   </para>
   
   <para os="sles;sled">
    Si vous utilisez Btrfs en tant que système de fichiers racines sur votre machine, assurez-vous qu'il dispose de suffisamment d'espace libre. Vérifiez l'espace disponible sur toutes les partitions montées. Dans le pire des cas, une mise à niveau a besoin d'autant d'espace disque que le système de fichiers racine actuel (sans le répertoire <filename>/.snapshot</filename>) pour un nouvel instantané.
   </para>
   
   <para>
    Les recommandations suivantes ont fait leurs preuves :
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Pour tous les systèmes de fichiers, y compris Btrfs, vous avez besoin de suffisamment d'espace disque disponible pour télécharger et installer des RPM volumineux. L'espace occupé par les anciens RPM n'est libéré qu'après l'installation des nouveaux RPM.
     </para>
    </listitem>
    <listitem>
     <para>
      Pour Btrfs avec des instantanés, vous avez au minimum besoin d'une quantité d'espace libre égale à celle occupée par votre installation actuelle. Il est recommandé de disposer de deux fois plus d'espace libre que celui occupé par l'installation actuelle.
     </para>
     <para>
      Si vous ne disposez pas de suffisamment d'espace, vous pouvez tenter de supprimer les anciens instantanés à l'aide de <command>snapper</command> :
     </para>
     <screen><prompt role="root"># </prompt><command>snapper</command> list
      <prompt role="root"># </prompt><command>snapper</command> delete NUMBER</screen>
     <para>
      Toutefois, cela ne fonctionne pas toujours. Avant la migration, la plupart des instantanés n'occupent pas tellement d'espace.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-update-preparation-packagelist">
  <title>Liste des paquets et dépôts installés</title>

  <para>
   <remark>jufa 2021-02-08: explain importance and purposeof this list.
    Clarify if requirement or suggestion?
    Used for reverting changes or to set-up new system?</remark>
   Vous pouvez enregistrer une liste des paquets installés ; par exemple pour effectuer une nouvelle installation d'une nouvelle version majeure de SLE ou pour revenir à l'ancienne version.
  </para>

  <note>
   <para>
    <remark>jufa: check if manual editing is still relevant 2021-02-09</remark>
    N'oubliez pas que les paquets installés ou dépôts utilisés ne sont pas tous disponibles dans les versions plus récentes de SUSE Linux Enterprise. Certains ont parfois été renommés et d'autres remplacés. Il se peut aussi que certains paquets restent disponibles pour des raisons d'héritage, mais qu'un autre paquet soit utilisé par défaut. Par conséquent, une modification manuelle des fichiers peut s'avérer nécessaire. Elle peut être réalisée avec n'importe quel éditeur de texte.
   </para>
  </note>

  <procedure>
   <step>
    <para>
     Créez un fichier nommé <filename>repositories.bak.repo</filename> contenant une liste de tous les dépôts utilisés :
    </para>
<screen><prompt role="root"># </prompt><command>zypper</command> lr -e repositories.bak</screen>
   </step>
   <step>
    <para>
     Créez un fichier nommé <filename>installed-software.bak</filename> contenant une liste de tous les paquets utilisés :
    </para>
<screen><prompt role="root"># </prompt><command>rpm</command> -qa --queryformat '%{NAME}\n' &gt; installed-software.bak</screen>
   </step>
   <step>
    <para>
     Sauvegardez les fichiers. Les dépôts et paquets installés peuvent être restaurés à l'aide des commandes suivantes :
    </para>
<screen os="sles;sled"><prompt role="root"># </prompt><command>zypper</command> ar repositories.bak.repo
<prompt role="root"># </prompt><command>zypper</command> install $(cat installed-software.bak)
</screen>

    <note os="sles;sled" xml:id="note-update-prep-backup-package-amount">
     <title>augmentation du nombre de paquets en cas de mise à jour vers une nouvelle version majeure</title>
     <para>
      Un système mis à niveau vers une nouvelle version majeure (SLE <replaceable>X+1</replaceable>) peut contenir plus de paquets que le système initial (SLE <replaceable>X</replaceable>). Il en contient aussi davantage qu'une nouvelle installation de SLE <replaceable>X+1</replaceable> avec la même sélection de modèle. Il existe plusieurs raisons à cela :
     </para>
     <itemizedlist>
      <listitem>
       <para>
        Les paquets ont été divisés pour permettre de les sélectionner de manière plus précise. Par exemple, 37 paquets <package>texlive</package> sous SLE 11 ont été répartis en plus de 3 000 paquets sous SLE 15.
       </para>
      </listitem>
      <listitem>
       <para>
        Lorsqu'un paquet a été divisé, tous les nouveaux paquets sont installés de manière à conserver les mêmes fonctionnalités que la version précédente en cas de mise à niveau. Toutefois, la nouvelle configuration par défaut pour une nouvelle installation de SLE <replaceable>X+1</replaceable> ne consiste pas forcément à installer tous les paquets.
       </para>
      </listitem>
      <listitem>
       <para>
        Les paquets hérités de SLE <replaceable>X</replaceable> peuvent être conservés pour des raisons de compatibilité.
       </para>
      </listitem>
      <listitem>
       <para>
        Les dépendances de paquets et l'étendue des modèles peuvent avoir changé.
       </para>
      </listitem>
     </itemizedlist>
    </note>
    
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-update-preparation-ltss">
  <title>Désactivation de l'extension LTSS</title>
  <para>
   Si vous mettez à niveau un système <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> avec l'extension LTSS (Long Term Service Pack Support) vers une version bénéficiant encore d'un support général, la mise à niveau échoue avec l'erreur <literal>No migration available</literal> (Aucune migration disponible). Cela se produit car <command>zypper migration</command> tente de migrer <emphasis>tous</emphasis> les dépôts, mais il n'existe pas encore de dépôt LTSS pour la nouvelle version.
  </para>
  <para>
   Pour résoudre ce problème, désactivez l'extension LTSS avant la mise à niveau.
  </para>
  <procedure>
   <step>
    <para>
     Vérifiez si l'extension LTSS est activée :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect --list-extensions | grep LTSS
SUSE Linux Enterprise Server LTSS 12 SP4 x86_64 (Installed)
Deactivate with: SUSEConnect -d -p SLES-LTSS/12.4/x86_64</screen>
   </step>
   <step>
    <para>
     Désactivez l'extension LTSS avec la commande de la sortie <command>SUSEConnect</command> ci-dessus :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect -d -p SLES-LTSS/12.4/x86_64
Deregistered SUSE Linux Enterprise Server LTSS 12 SP4 x86_64
To server: https://scc.suse.com/</screen>
   </step>
   <step>
    <para>
     Vérifiez que le dépôt LTSS n'est plus présent avec <command>zypper lr</command>.
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 os="sles" xml:id="sec-update-preparation-postgresql">
  <title>Migration de votre base de données PostgreSQL</title>

  <para>
   
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase role="productnumber"><phrase os="sles;sled">15 SP7</phrase></phrase> est livré avec les versions 14, 15 et 16 de la base de données PostgreSQL. Bien que la version 16 soit la version par défaut, les versions 14 et 15 sont toujours fournies via le module <literal>Legacy</literal> pour les mises à niveau à partir de versions antérieures de <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>.
  </para>

  <para>
   En raison du travail de migration requis pour la base de données, le processus de mise à niveau n'est pas automatique. De ce fait, le passage d'une version à l'autre doit être effectué manuellement.
  </para>

  <para>
   La migration est exécutée à l'aide de la commande <command>pg_upgrade</command>. Il s'agit d'une autre méthode par rapport au vidage et au rechargement classiques. Par rapport à la méthode de <quote>vidage et rechargement</quote>, la migration effectuée à l'aide de la commande <command>pg_upgrade</command> est plus rapide.
  </para>

  <para>
   Les fichiers programmes de chaque version PostgreSQL sont stockés dans des répertoires différents selon la version, Par exemple, dans <filename>/usr/lib/postgresql96/</filename> pour la version 9.6, dans <filename>/usr/lib/postgresql10/</filename> pour la version 10 et dans <filename>/usr/lib/postgres13/</filename> pour la version 13. Notez que la stratégie de contrôle des versions de PostgreSQL a changé entre les versions majeures 9.6 et 10. Pour plus de détails, reportez-vous à l'adresse <link xlink:href="https://www.postgresql.org/support/versioning/"></link>.
  </para>

  <important>
   <title>mise à niveau à partir de SLE 11</title>
   <para>
    Lors de la mise à niveau à partir de SLE 11, <systemitem>postgresql94</systemitem> sera désinstallé et ne pourra plus être utilisé pour la migration de la base de données vers une version ultérieure de PostgreSQL. Par conséquent, veillez à migrer la base de données PostgreSQL <emphasis>avant</emphasis> de mettre à niveau votre système.
   </para>
  </important>

  <para>
   La procédure ci-dessous décrit la migration de la base de données de la version 12 vers la version 13. Lorsque vous utilisez une version différente comme source ou comme cible, remplacez les numéros de version en conséquence.
  </para>

  <para>
   Pour effectuer la migration de la base de données, procédez comme suit :
  </para>

  <procedure>
   <step>
    <para>
     Assurez-vous que les conditions préalables suivantes sont remplies :
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Si ce n'est déjà fait, mettez à niveau les paquets de l'ancienne version de PostgreSQL vers la version la plus récente par le biais d'une mise à jour de maintenance.
      </para>
     </listitem>
     <listitem>
      <para>
       Créez une sauvegarde de votre base de données existante.
      </para>
     </listitem>
     <listitem>
      <para>
       Installez les paquets de la nouvelle version majeure de PostgreSQL. Pour SLE 15 SP7, cela implique d'installer <package>postgresql13-server</package> et tous les paquets dont il dépend.
      </para>
     </listitem>
     <listitem>
      <para>
       Installez le paquet <package>postgresql13-contrib</package> qui contient la commande <command>pg_upgrade</command>.
      </para>
     </listitem>
     <listitem>
      <para>
       Assurez-vous que vous disposez de suffisamment d'espace disponible dans la zone de stockage des données PostgreSQL, par défaut <filename>/var/lib/pgsql/data</filename>. Si l'espace risque d'être insuffisant, essayez de réduire la taille à l'aide de la commande SQL suivante sur chaque base de données (cette opération peut prendre un certain temps) :
      </para>
<screen>VACUUM FULL</screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Arrêtez le serveur PostgreSQL avec une des commandes suivantes :
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
    <para>
     ou
    </para>
<screen><prompt role="root"># </prompt>systemctl stop postgresql.service</screen>
    <para>
     (Selon la version SLE que vous utilisez comme version de départ pour la mise à niveau)
    </para>
   </step>
   <step>
    <para>
     Renommez votre ancien répertoire de données :
    </para>
<screen><prompt role="root"># </prompt><command>mv</command> /var/lib/pgsql/data /var/lib/pgsql/data.old</screen>
   </step>
   <step>
    <para>
     Initialisez votre nouvelle instance de base de données, soit manuellement avec <command>initdb</command>, soit en démarrant et arrêtant PostgreSQL, qui le fera automatiquement :
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> start
<prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
    <para>
     ou
    </para>
<screen><prompt role="root"># </prompt>systemctl start postgresql.service
<prompt role="root"># </prompt>systemctl stop postgresql.service</screen>
    <para>
     (Selon la version SLE que vous utilisez comme version de départ pour la mise à niveau)
    </para>
   </step>
   <step>
    <para>
     Si vous avez modifié les fichiers de configuration dans l'ancienne version, pensez à transférer ces modifications vers les nouveaux fichiers de configuration. Cela peut affecter les fichiers <filename>postgresql.auto.conf</filename>, <filename>postgresql.conf</filename>,<filename>pg_hba.conf</filename> et <filename>pg_ident.conf</filename>. Les anciennes versions de ces fichiers se trouvent à l'emplacement <filename>/var/lib/pgsql/data.old/</filename> et les nouvelles versions sont disponibles à l'emplacement <filename>/var/lib/pgsql/data</filename>.
    </para>
    <para>
     Notez qu'il est déconseillé de copier les anciens fichiers de configuration, car cela peut écraser de nouvelles options, de nouvelles valeurs par défaut et des commentaires modifiés.
    </para>
   </step>
   <step>
    <para>
     Démarrez le processus de migration en tant qu'utilisateur <systemitem class="username">postgres</systemitem> :
    </para>
<screen><prompt role="root"># </prompt>su - postgres
postgres &gt; <command>pg_upgrade</command> \
 --old-datadir "/var/lib/pgsql/data.old" \
 --new-datadir "/var/lib/pgsql/data" \
 --old-bindir "/usr/lib/postgresql12/bin/" \
 --new-bindir "/usr/lib/postgresql13/bin/"</screen>
   </step>
   <step>
    <para>
     Démarrez votre nouvelle instance de base de données avec l'une des commandes suivantes :
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> start</screen>
    <para>
     ou
    </para>
<screen><prompt role="root"># </prompt>systemctl start postgresql.service</screen>
    <para>
     (Selon la version SLE que vous utilisez comme version de départ pour la mise à niveau)
    </para>
   </step>
   <step>
    <para>
     Vérifiez si la migration a réussi. L'étendue du test dépend de votre utilisation ; il n'existe aucun outil général permettant d'automatiser cette étape.
    </para>
   </step>
   <step>
    <para>
     Supprimez les anciens paquets PostgreSQL et votre ancien répertoire de données :
    </para>
<screen><prompt role="root"># </prompt><command>zypper</command> search -s postgresql12| xargs zypper rm -u
<prompt role="root"># </prompt><command>rm</command> -rf /var/lib/pgsql/data.old</screen>
   </step>
  </procedure>

  <para>
   Pour plus d'informations sur la mise à niveau des bases de données ou l'utilisation de méthodes alternatives telles que la réplication logique, reportez-vous à la documentation officielle de PostgreSQL à l'adresse <link xlink:href="https://www.postgresql.org/docs/13/upgrading.html"></link>.
  </para>
 </sect1>

 <sect1 os="sles" xml:id="sec-update-preparation-mariadb">
  <title>Migration de votre base de données MySQL ou MariaDB</title>
  <remark>toms 2015-09-03: already reviewed by Ondrej and Kristýna.</remark>
  <para>
   À partir de la version 12 de SUSE Linux Enterprise, SUSE est passé de MySQL à MariaDB. Avant de lancer une mise à niveau, il est vivement recommandé de sauvegarder votre base de données.
  </para>
  <para>
   Pour effectuer la migration de la base de données, procédez comme suit :
  </para>
  <procedure>
   <step>
    <para>
     Créez un fichier de vidage :
    </para>
    <remark>cwickert 2022-07-07: '--add-drop-database' is required for <link xlink:href="https://bugzilla.suse.com/show_bug.cgi?id=1166786">BSC#1166786</link>&#x002E;</remark>
    <screen><prompt role="root"># </prompt><command>mysqldump</command> -u root -p --all-databases --add-drop-database &gt; mysql_backup.sql</screen>
    <para>
     Par défaut, <command>mysqldump</command> ne vide pas la base de données <literal>INFORMATION_SCHEMA</literal> ni <literal>performance_schema</literal>. Pour plus d'informations, reportez-vous à la section de la base de connaissances <link xlink:href="https://mariadb.com/kb/en/mariadb-dumpmysqldump/"></link>.
    </para>
   </step>
   <step>
    <para>
     Enregistrez votre fichier de vidage, le fichier de configuration <filename>/etc/my.cnf</filename> ainsi que le répertoire <filename>/etc/mysql/</filename> pour le consulter ultérieurement (mais <emphasis>pas</emphasis> l'installation) à un endroit sûr.
    </para>
   </step>
   <step>
    <para>
     Effectuez la mise à niveau de <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>. Après la mise à niveau, votre ancien fichier de configuration <filename>/etc/my.cnf</filename> sera inchangé. La nouvelle configuration est disponible dans le fichier <filename>/etc/my.cnf.rpmnew</filename>.
    </para>
   </step>
   <step>
    <para>
     Configurez votre base de données MariaDB selon vos besoins. <emphasis>N'utilisez pas</emphasis> les anciens répertoires et fichiers de configuration. Vous pouvez toutefois les adapter et vous en servir comme références.
    </para>
   </step>
   <step>
    <para>
     Assurez-vous que vous démarrez le serveur MariaDB :
    </para>
    <screen><prompt role="root"># </prompt><command>systemctl</command> start mariadb</screen>
    <para>
     Si vous voulez lancer le serveur MariaDB à chaque démarrage, activez ce service :
    </para>
    <screen><prompt role="root"># </prompt><command>systemctl</command> enable mariadb</screen>
   </step>
   <step>
    <para>
     Vérifiez que MariaDB s'exécute correctement en vous connectant à la base de données :
    </para>
    <screen><prompt role="root"># </prompt><command>mariadb</command> -u root -p</screen>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-update-preparation-ssl">
  <title>Création de certificats de serveur non-MD5 pour les applications Java</title>
  <remark>toms 2016-07-27: from bsc#970153, c#24</remark>
  <remark>jufa 2021-02-09: FIXME check if still relevant, check which versions are affected</remark>
  <remark>cwickert-2022-07-07: Change occurred during the upgrade from
   java-1_8_0-openjdk-1.8.0.65-1.13 to java-1_8_0-openjdk-1.8.0.72-3.2, means
   for SLES it happened between SLES 12 GA and SP1. So still relevant.
  </remark>
  <para>
   Par mesure de sécurité, les certificats MD5 ne sont plus pris en charge dans Java. Si vous disposez de certificats créés à l'aide de l'algorithme MD5, recréez vos certificats en procédant comme suit :
  </para>
  <procedure>
   <step>
    <para>
     Ouvrez un terminal et connectez-vous en tant qu'utilisateur <systemitem class="username">root</systemitem>.
    </para>
   </step>
   <step>
    <para>
     Créez une clé privée :
    </para>
    <screen><prompt role="root"># </prompt><command>openssl</command> genrsa -out server.key 1024</screen>
    <para>
     Si vous souhaitez une clé renforcée, remplacez <literal>1024</literal> par un nombre plus élevé, par exemple <literal>4096</literal>.
    </para>
   </step>
   <step>
    <para>
     Créez une requête de signature de certificat (CSR) :
    </para>
    <screen><prompt role="root"># </prompt><command>openssl</command> req -new -key server.key -out server.csr</screen>
   </step>
   <step>
    <para>
     Auto-signez le certificat :
    </para>
    <screen><prompt role="root"># </prompt><command>openssl</command> x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</screen>
   </step>
   <step>
    <para>
     Créez le fichier PEM :
    </para>
    <screen><prompt role="root"># </prompt><command>cat</command> server.key server.crt &gt; server.pem</screen>
   </step>
   <step>
    <para>
     Placez les fichiers <filename>server.crt</filename>, <filename>server.csr</filename>, <filename>server.key</filename>et <filename>server.pem</filename> dans les répertoires respectifs contenant les clés. Pour Tomcat, il s'agit par exemple du répertoire <filename>/etc/tomcat/ssl/</filename>.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-update-preparation-vms">
  <title>Arrêt des invités de machine virtuelle</title>

  <para>
   Si votre machine fait office de serveur hôte de machine virtuelle pour KVM<phrase os="sles;sled"> ou Xen</phrase>, veillez à arrêter correctement tous les invités de machine virtuelle actifs avant de procéder à la mise à jour. Dans le cas contraire, l'accès aux invités peut s'avérer impossible après la mise à jour.
  </para>
 </sect1>
 <sect1 os="sles;sled" xml:id="sec-update-preparation-rmt">
  <title>Ajustement de la configuration du client SMT</title>

  <para>
   Si la machine que vous souhaitez mettre à niveau est enregistrée comme client auprès d'un serveur SMT, procédez comme suit :
  </para>

  <para>
   Vérifiez si la version du script <command>clientSetup4SMT.sh</command> sur votre hôte est à jour. La commande <command>clientSetup4SMT.sh</command> à partir d'anciennes versions de SMT ne peut pas gérer les clients SMT 12. Si vous appliquez régulièrement des correctifs logiciels sur votre serveur SMT, vous pouvez toujours trouver la dernière version de <command>clientSetup4SMT.sh</command> dans <filename>&lt;SMT_HOSTNAME&gt;/repo/tools/clientSetup4SMT.sh</filename>.
  </para>

  <para>
   En cas d'échec de la mise à niveau de votre machine vers une version ultérieure de <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>, annulez l'enregistrement de la machine auprès du serveur SMT, comme décrit à la <xref linkend="pro-sec-update-prep-smt-de-register" xrefstyle="select:label"/>. Ensuite, redémarrez le processus de mise à niveau.
  </para>

  <procedure xml:id="pro-sec-update-prep-smt-de-register">
   <title>annulation de l'enregistrement d'un client SUSE Linux Enterprise auprès d'un serveur SMT</title>
   <step>
    <para>
     Connectez-vous à la machine client.
    </para>
   </step>
   <step>
    <para>
     L'étape suivante dépend du système d'exploitation actuel du client :
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Pour SUSE Linux Enterprise 11, exécutez les commandes suivantes :
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> suse_register -E
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/suseRegister*
<prompt>&gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/lastzmdconfig.cache
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zmd/deviceid
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zmd/secret</screen>
     </listitem>
     <listitem>
      <para>
       Pour SUSE Linux Enterprise 12, exécutez les commandes suivantes :
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect --de-register
<prompt>&gt; </prompt><command>sudo</command> SUSEConnect --cleanup
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*</screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Connectez-vous au serveur SMT.
    </para>
   </step>
   <step>
    <para>
     Vérifiez si l'enregistrement du client a été annulé avec succès en répertoriant tous les enregistrements de clients :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-list-registrations</screen>
   </step>
   <step>
    <para>
     Si le nom d'hôte du client est toujours répertorié dans la sortie de cette commande, obtenez l'<literal>Unique ID</literal> du client à partir de la première colonne. (Le client peut être répertorié avec plusieurs ID.)
    </para>
   </step>
   <step>
    <para>
     Supprimez l'enregistrement pour ce client :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-delete-registration -g <replaceable>UNIQUE_ID</replaceable></screen>
   </step>
   <step>
    <para>
     Si le client est répertorié avec plusieurs ID, répétez l'étape ci-dessus pour chacun de ses ID uniques.
    </para>
   </step>
   <step>
    <para>
     Vérifiez si l'enregistrement du client a maintenant été annulé avec succès en réexécutant :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-list-registrations</screen>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-autoyast-profiles" os="sles">
  <title>Modifications des profils AutoYaST de SLE 12 vers SLE 15</title>

  <para>
   Pour savoir comment migrer vos profils AutoYaST, reportez-vous au manuel <xref linkend="appendix-ay-12vs15"/>.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-smt-to-rmt" os="sles">
  <title>Mise à niveau d'un serveur SMT (Subscription Management Tool)</title>

  <para>
   Un serveur qui exécute SMT requiert une procédure de mise à niveau spéciale. Reportez-vous au <xref linkend="cha-rmt-migrate"/> du Repository Mirroring Tool Guide (Guide de RMT).
  </para>
 </sect1>
 <sect1 os="sles" xml:id="sec-update-preparation-multiversion">
  <title>Désactivation temporaire de la prise en charge de plusieurs versions du kernel</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> (SLES) permet d'installer plusieurs versions de kernel en activant les paramètres correspondants à l'emplacement <filename>/etc/zypp/zypp.conf</filename>. La prise en charge de cette fonctionnalité doit pourtant être désactivée temporairement pour effectuer une mise à niveau vers un Service Pack. Une fois la mise à jour terminée, la prise en charge de plusieurs versions peut être réactivée. Pour désactiver la prise en charge de plusieurs versions, commentez les lignes correspondantes dans <filename>/etc/zypp/zypp.conf</filename>. Le résultat doit ressembler à ceci :
  </para>

<screen>#multiversion = provides:multiversion(kernel)
#multiversion.kernels = latest,running</screen>

  <para>
   Pour réactiver cette fonction après une mise à jour réussie, supprimez les signes de commentaire. Pour plus d'informations sur la prise en charge de plusieurs versions, reportez-vous à la <xref linkend="sec-tuning-multikernel-enable"/>.
  </para>
 </sect1>
 <sect1 xml:id="sec-upgrade-prepare-boot-config">
  <title>Ajustage du paramètre de démarrage <literal>resume</literal></title>
  <para>
   Sur les systèmes qui ont été installés avec <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 12 ou version antérieure, la ligne de commande du kernel par défaut dans <filename>/etc/default/grub</filename> peut contenir un paramètre <parameter>resume</parameter> utilisant un nom de noeud de périphérique, par exemple <filename>/dev/sda1</filename>, pour faire référence au périphérique d'hibernation (mise en veille sur disque). Étant donné que les noms de noeud de périphérique ne sont pas persistants et peuvent changer entre les redémarrages, il est vivement recommandé de corriger ce problème. Sinon, le système mis à niveau risque de se bloquer au redémarrage.
  </para>
  <procedure>
   <step>
    <para>
     Recherchez le périphérique d'hibernation :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>grep resume /etc/default/grub</command>
GRUB_CMDLINE_LINUX_DEFAULT="resume=/dev/sda1 splash=silent quiet showopts"
</screen>
    <para>
     Le périphérique d'hibernation est <filename>/dev/sda1</filename>. Si la commande ne renvoie rien, l'hibernation n'est pas configurée.
    </para>
   </step>
   <step>
    <para>
     Obtenez l'UUID pour <filename><replaceable>/dev/sda1</replaceable></filename> :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>blkid /dev/vda1</command>
/dev/vda1: UUID="a1d1f2e0-b0ee-4be2-83d5-78a98c585827" TYPE="swap" PARTUUID="000134b5-01"</screen>
    <para>
     L'UUID pour <filename>/dev/sda1</filename> est <literal>a1d1f2e0-b0ee-4be2-83d5-78a98c585827</literal>.
    </para>
   </step>
   <step>
    <para>
     Modifiez le fichier <filename>/etc/default/grub</filename> et ajustez le paramètre <parameter>resume</parameter>. Remplacez <literal><replaceable>/dev/sda1</replaceable></literal> par <literal><replaceable>UUID=a1d1f2e0-b0ee-4be2-83d5-78a98c585827</replaceable></literal>. Le résultat ressemblera à ceci :
    </para>
<screen>GRUB_CMDLINE_LINUX_DEFAULT="resume=UUID=a1d1f2e0-b0ee-4be2-83d5-78a98c585827 splash=silent quiet showopts"</screen>
   </step>
   <step>
    <para>
     Mettez à jour la configuration du gestionnaire d'amorçage GRUB :
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>grub2-mkconfig -o /boot/grub2/grub.cfg</command></screen>
   </step>
  </procedure>
  <para>
   Si le système n'utilise pas l'hibernation, vous pouvez simplement supprimer le paramètre <parameter>resume</parameter> et mettre à jour la configuration de démarrage.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-zseries" os="sles">
  <title>Mise à niveau sur IBM Z</title>

  <para>
   La mise à niveau d'une installation SUSE Linux Enterprise sur IBM Z nécessite <command>Upgrade=1</command> comme paramètre de kernel, par exemple via le fichier parmfile. Reportez-vous à la page <xref linkend="sec-appdendix-parm"/>.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-ppc" os="sles" arch="power">
  <title>IBM POWER : démarrage d'un serveur X</title>

  <para>
   Sous SLES 12 pour IBM POWER, le gestionnaire d'affichage est configuré pour ne pas démarrer un serveur X local par défaut. Ce paramètre a été annulé sous SLES 12 SP1. Le gestionnaire d'affichage démarre désormais un serveur X.
  </para>

  <para>
   Pour éviter des problèmes au cours de la mise à niveau, le paramètre <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> n'est pas modifié automatiquement. Si vous souhaitez que le gestionnaire d'affichage démarre un serveur X après la mise à niveau, modifiez le paramètre <envar>DISPLAYMANAGER_STARTS_XSERVER</envar> dans <filename>/etc/sysconfig/displaymanager</filename> comme suit :
  </para>

<screen>DISPLAYMANAGER_STARTS_XSERVER="yes"</screen>
 </sect1>
</chapter>
